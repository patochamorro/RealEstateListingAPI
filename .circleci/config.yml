version: 2.1
orbs:
  windows: circleci/windows@5.1.1
jobs:
  test:
    description: Setup and run application tests
    executor:
      name: windows/default
    steps:
      - checkout
      # Install .NET 8 SDK
      - run:
          name: Install .NET 8 SDK
          command: |            
            dotnet tool install --global coveralls.net
            choco install dotnet-8.0-sdk -y
            dotnet --info
      - restore_cache:
          keys:
            - dotnet-packages-v1-{{ checksum "RealEstateListingApi/RealEstateListingApi.csproj" }}
      - run:
          name: "Install project dependencies"
          command: dotnet.exe restore
      - save_cache:
          paths:
            - C:\Users\circleci\.nuget\packages
          key: dotnet-packages-v1-{{ checksum "RealEstateListingApi/RealEstateListingApi.csproj" }}
      - run:
          name: "Run Application Tests"
          command: |
            dotnet test `
              --collect:"XPlat Code Coverage" `
              --settings:"coverage.runsettings"

            $cov = Get-ChildItem -Recurse -Filter "coverage.opencover.xml" | Select-Object -First 1

            if (-not $cov) {
              Write-Error "No se encontr√≥ coverage.opencover.xml"
              exit 1
            }

            csmacnz.Coveralls `
              --opencover `
              -i $cov.FullName `
              --repoTokenVariable COVERALLS_REPO_TOKEN `
              --useRelativePaths
          environment:
            COVERALLS_REPO_TOKEN: jGHR3d1dU9VQOj9ZwbhbFiDyuhAPiWwNA

  build:
    description: Build application with Release configuration
    executor:
      name: windows/default
    steps:
      - checkout
       # Install .NET 8 SDK
      - run:
          name: Install .NET 8 SDK
          command: |
            choco install dotnet-8.0-sdk -y
            dotnet --info
      - run:
          name: "Build Application according to some given configuration"
          command: dotnet.exe build --configuration Release
workflows:
  test_and_build:
    jobs:
      - test
      - build:
          requires:
            - test